<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>ê³¼ì œ ìë™ ì½”ì¹˜ Agent</title>
</head>
<style>
  body { margin: 0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; background: #f7fafc; height: 100vh; display: flex; overflow: hidden; }
  
  /* ë ˆì´ì•„ì›ƒ */
  .sidebar { width: 260px; background: #2d3748; color: white; display: flex; flex-direction: column; flex-shrink: 0; box-shadow: 2px 0 5px rgba(0,0,0,0.1); }
  .main-content { flex: 1; display: flex; flex-direction: column; height: 100vh; overflow: hidden; position: relative; }
  
  /* ì‚¬ì´ë“œë°” ìŠ¤íƒ€ì¼ */
  .sidebar-header { padding: 20px; border-bottom: 1px solid #4a5568; font-weight: bold; font-size: 1.2rem; display: flex; align-items: center; justify-content: space-between; }
  .new-chat-btn { margin: 20px; padding: 10px; background: #3182ce; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; transition: background 0.2s; }
  .new-chat-btn:hover { background: #2b6cb0; }
  .history-list { flex: 1; overflow-y: auto; padding: 10px; list-style: none; margin: 0; }
  .history-item { padding: 10px 12px; margin-bottom: 4px; border-radius: 6px; cursor: pointer; color: #cbd5e0; font-size: 0.9rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; transition: background 0.2s; }
  .history-item:hover { background: #4a5568; color: white; }
  .history-item.active { background: #4a5568; color: white; font-weight: bold; }
  
  /* ë©”ì¸ ì˜ì—­ ìŠ¤íƒ€ì¼ */
  .scroll-area { flex: 1; overflow-y: auto; padding: 30px; padding-bottom: 100px; /* footer space */ scroll-behavior: smooth; }
  .input-container { background: #fff; padding: 20px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); margin-bottom: 30px; max-width: 800px; margin-left: auto; margin-right: auto; }
  .cards-container { max-width: 800px; margin: 0 auto; }
  
  /* ìœ í‹¸ */
  h1 { margin: 0; font-size: 1.5rem; color: #2d3748; margin-bottom: 20px; text-align: center; }
  textarea { transition: border 0.2s; }
  textarea:focus { outline: none; border-color: #3182ce; }
</style>
</head>
<body>

<!-- ì‚¬ì´ë“œë°” -->
<div class="sidebar">
  <div class="sidebar-header">
    Agent Coach
    <span style="font-size: 0.8rem; background: #4a5568; padding: 2px 6px; border-radius: 4px;">v1.0</span>
  </div>
  <button class="new-chat-btn" id="btn-new">+ ìƒˆë¡œìš´ ì§„ë‹¨</button>
  <div style="padding: 0 20px; font-size: 0.8rem; color: #a0aec0; margin-bottom: 4px;">íˆìŠ¤í† ë¦¬</div>
  <ul class="history-list" id="history-list">
    <!-- JSë¡œ ë Œë”ë§ -->
  </ul>
</div>

<!-- ë©”ì¸ ì½˜í…ì¸  -->
<div class="main-content">
  <div class="scroll-area" id="scroll-area">
    <h1>ğŸ“ ìë™ ì½”ì¹˜ ì—ì´ì „íŠ¸</h1>
    
    <!-- ì…ë ¥ ì˜ì—­ (ìƒë‹¨ ê³ ì •ì²˜ëŸ¼ ë³´ì´ì§€ë§Œ ìŠ¤í¬ë¡¤ì— í¬í•¨ë¨) -->
    <div class="input-container">
      <div style="display: flex; gap: 10px; margin-bottom: 10px;">
        <select id="preset" style="flex: 1; padding: 8px; border: 1px solid #e2e8f0; border-radius: 6px;">
          <option value="">í”„ë¦¬ì…‹ ì„ íƒ...</option>
          <option value="todo_api">1) Node.js Todo API ì ê²€</option>
          <option value="compose_net">2) Docker Compose ë„¤íŠ¸ì›Œí¬/í¬íŠ¸ ì ê²€</option>
          <option value="db_charset">3) MySQL í•œê¸€/ì¸ì½”ë”© ì ê²€</option>
        </select>
        <button id="btn-clear" style="padding: 8px 12px; background: #edf2f7; border: none; border-radius: 6px; cursor: pointer;">ì´ˆê¸°í™”</button>
      </div>

      <textarea id="question" rows="4" style="width: 96%; padding: 12px; border: 1px solid #e2e8f0; border-radius: 6px; resize: vertical; mb-2" 
        placeholder="ì§ˆë¬¸, ì—ëŸ¬ ë¡œê·¸, í˜¹ì€ ì„¤ì • íŒŒì¼ ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”."></textarea>
      
      <div style="margin-top: 10px; text-align: right;">
        <button id="btn-send" style="background: #3182ce; color: white; border: none; padding: 10px 24px; border-radius: 6px; font-weight: bold; cursor: pointer; box-shadow: 0 2px 4px rgba(49,130,206,0.3);">
          ì§„ë‹¨ ìš”ì²­
        </button>
      </div>
    </div>

    <!-- ê²°ê³¼ íˆìŠ¤í† ë¦¬ ì˜ì—­ -->
    <div class="cards-container" id="cards-area"></div>
    <div id="bottom-anchor"></div>
  </div>
</div>

<script>
  // DOM ìš”ì†Œ
  const presetEl = document.querySelector("#preset");
  const questionEl = document.querySelector("#question");
  const sendBtn = document.querySelector("#btn-send");
  const clearBtn = document.querySelector("#btn-clear");
  const newChatBtn = document.querySelector("#btn-new");
  const cardsArea = document.querySelector("#cards-area");
  const historyListEl = document.querySelector("#history-list");
  const scrollArea = document.querySelector("#scroll-area");

  // ìƒíƒœ ê´€ë¦¬
  let historyData = JSON.parse(localStorage.getItem("coach_history") || "[]");
  let currentSessionId = null;

  // ì´ˆê¸°í™”
  init();

  function init() {
    renderHistoryList();
    startNewSession();
  }

  function startNewSession() {
    currentSessionId = "session-" + Date.now();
    cardsArea.innerHTML = ""; // í™”ë©´ ë¹„ìš°ê¸°
    presetEl.value = "";
    questionEl.value = "";
    questionEl.placeholder = "ìƒˆë¡œìš´ ì§„ë‹¨ì„ ì‹œì‘í•©ë‹ˆë‹¤.";
    
    // ë¹„ì–´ìˆëŠ” ì„¸ì…˜ì€ ì•„ì§ ì €ì¥í•˜ì§€ ì•ŠìŒ (ì²« ì§ˆë¬¸ ì‹œ ì €ì¥)
    renderHistoryList();
  }

  function loadSession(sessionId) {
    const session = historyData.find(s => s.id === sessionId);
    if (!session) return;

    currentSessionId = sessionId;
    cardsArea.innerHTML = ""; // ë¹„ìš°ê³ 
    
    // ì €ì¥ëœ ëŒ€í™” ì¹´ë“œ ë³µì›
    session.chats.forEach(chat => {
      const card = createResultCard(chat.question, chat.data, chat.isError, chat.timestamp);
      cardsArea.insertAdjacentElement('afterbegin', card); // ìµœì‹ ìˆœ (ì—­ìˆœ ì €ì¥ë˜ì–´ ìˆë‹¤ë©´ ìˆœì„œ ì£¼ì˜)
    });

    // UX: ì €ì¥ëœ ì„¤ì • ë¶ˆëŸ¬ì˜¤ê¸° (ë§ˆì§€ë§‰ í”„ë¦¬ì…‹)
    if(session.chats.length > 0) {
      // ê°€ì¥ ìµœê·¼(ë°°ì—´ì˜ 0ë²ˆ) í˜¹ì€ ë§ˆì§€ë§‰ ëŒ€í™”ì˜ í”„ë¦¬ì…‹?
      // ì—¬ê¸°ì„  í¸ì˜ìƒ 0ë²ˆ ì‚¬ìš©
       // presetEl.value = ... (ì €ì¥ ë¡œì§ì— í”„ë¦¬ì…‹ë„ ë„£ìœ¼ë©´ ì¢‹ìŒ)
    }
    
    renderHistoryList();
  }

  function saveChatToHistory(qText, data, isError) {
    let session = historyData.find(s => s.id === currentSessionId);
    
    // ì„¸ì…˜ ì—†ìœ¼ë©´ ìƒì„± (ì²« ëŒ€í™”)
    if (!session) {
      session = {
        id: currentSessionId,
        title: qText.substring(0, 20) + (qText.length > 20 ? "..." : ""),
        timestamp: Date.now(),
        chats: []
      };
      historyData.unshift(session); // ë§¨ ì•ì— ì¶”ê°€
    } else {
      // ì œëª© ì—…ë°ì´íŠ¸ (ì²« ì§ˆë¬¸ì´ ì œëª©ì´ ë¨)
      if (session.chats.length === 0) {
         session.title = qText.substring(0, 20) + (qText.length > 20 ? "..." : "");
      }
      session.timestamp = Date.now(); // ê°±ì‹  ì‹œê°„ ì—…ë°ì´íŠ¸
      // ë°°ì—´ ì¬ì •ë ¬: ìµœì‹  ì„¸ì…˜ì´ ìœ„ë¡œ ì˜¤ë„ë¡
      historyData = historyData.filter(s => s.id !== currentSessionId);
      historyData.unshift(session);
    }

    // ëŒ€í™” ë‚´ìš© ì¶”ê°€
    session.chats.unshift({ // ìµœì‹  ëŒ€í™”ê°€ ìœ„ë¡œ ì˜¤ê²Œ ì €ì¥
      question: qText,
      data: data,
      isError: isError,
      timestamp: Date.now()
    });

    // ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ ì €ì¥
    localStorage.setItem("coach_history", JSON.stringify(historyData));
    renderHistoryList();
  }

  function renderHistoryList() {
    historyListEl.innerHTML = "";
    historyData.forEach(session => {
      const li = document.createElement("li");
      li.className = `history-item ${session.id === currentSessionId ? 'active' : ''}`;
      li.textContent = session.title || "(ì œëª© ì—†ìŒ)";
      li.onclick = () => loadSession(session.id);
      
      // ì‚­ì œ ë²„íŠ¼ (ì˜µì…˜)
      // const delBtn = ...

      historyListEl.appendChild(li);
    });
  }

  function createResultCard(qText, data, isError = false, timestamp = Date.now()) {
    const card = document.createElement("div");
    card.style.background = "#fff";
    card.style.border = "1px solid #e2e8f0";
    card.style.borderRadius = "8px";
    card.style.padding = "20px";
    card.style.marginBottom = "20px";
    card.style.boxShadow = "0 2px 4px rgba(0,0,0,0.05)";
    
    const timeStr = new Date(timestamp).toLocaleTimeString();
    
    let statusHtml = "";
    if (isError) {
      statusHtml = `<span style="background:#fed7d7; color:#822727; padding:2px 8px; border-radius:4px; font-size:12px; font-weight:bold;">ğŸš¨ ERROR</span>`;
    } else if (data.status === "DONE") {
      statusHtml = `<span style="background:#c6f6d5; color:#22543d; padding:2px 8px; border-radius:4px; font-size:12px; font-weight:bold;">âœ… ì™„ë£Œ</span>`;
    } else if (data.status === "NEED_INFO") {
      statusHtml = `<span style="background:#feebc8; color:#744210; padding:2px 8px; border-radius:4px; font-size:12px; font-weight:bold;">âš ï¸ ì •ë³´ ë¶€ì¡±</span>`;
    } else {
      statusHtml = `<span style="background:#edf2f7; color:#4a5568; padding:2px 8px; border-radius:4px; font-size:12px; font-weight:bold;">ğŸ’¬ ëŒ€í™” ì¤‘</span>`;
    }

    card.innerHTML = `
      <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:12px; border-bottom:1px solid #eee; padding-bottom:8px;">
        <span style="font-size:13px; color:#718096;">${timeStr}</span>
        ${statusHtml}
      </div>
      <div style="font-weight:bold; color:#2d3748; margin-bottom:12px; line-height:1.5;">Q. ${qText}</div>
    `;

    // Trace
    if (data.trace && data.trace.length > 0) {
      const traceBox = document.createElement("div");
      traceBox.style.background = "#f7fafc";
      traceBox.style.padding = "10px";
      traceBox.style.borderRadius = "6px";
      traceBox.style.fontSize = "13px";
      traceBox.style.color = "#4a5568";
      traceBox.style.marginBottom = "12px";
      traceBox.style.borderLeft = "3px solid #cbd5e0";
      
      let traceHtml = `<div style="font-weight:bold; margin-bottom:4px; color:#2b6cb0;">ğŸ” ì§„ë‹¨ ë¡œê·¸</div>`;
      data.trace.forEach(step => {
        traceHtml += `<div style="margin-bottom:2px;"><span style="color:#a0aec0;">[${step.stage}]</span> ${step.message}</div>`;
      });
      traceBox.innerHTML = traceHtml;
      card.appendChild(traceBox);
    }

    // Answer
    const answerBox = document.createElement("div");
    answerBox.style.whiteSpace = "pre-wrap";
    answerBox.style.lineHeight = "1.6";
    answerBox.style.color = "#2d3748";
    answerBox.textContent = isError ? data.error : (data.answer || "ì‘ë‹µ ë‚´ìš© ì—†ìŒ");
    
    card.appendChild(answerBox);
    return card;
  }

  // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
  newChatBtn.addEventListener("click", startNewSession);
  
  clearBtn.addEventListener("click", () => {
    presetEl.value = "";
    questionEl.value = "";
    questionEl.focus();
  });

  sendBtn.addEventListener("click", async () => {
    const pid = presetEl.value;
    const q = questionEl.value.trim();

    if (!pid) { alert("í”„ë¦¬ì…‹ì„ ì„ íƒí•´ì£¼ì„¸ìš”!"); return; }
    if (!q) { alert("ì§ˆë¬¸ ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”!"); return; }

    const originalBtnText = sendBtn.textContent;
    sendBtn.textContent = "ë¶„ì„ ì¤‘...";
    sendBtn.disabled = true;

    try {
      // conversation_idëŠ” í˜„ì¬ ì„¸ì…˜ ID ì‚¬ìš©
      const res = await fetch("/api/coach", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ preset_id: pid, question: q, conversation_id: currentSessionId })
      });
      const data = await res.json().catch(() => ({}));
      
      const isError = !res.ok;
      
      // í™”ë©´ í‘œì‹œ
      const card = createResultCard(q, isError ? { error: data.error || "í†µì‹  ì˜¤ë¥˜" } : data, isError);
      cardsArea.insertAdjacentElement('afterbegin', card);
      
      // íˆìŠ¤í† ë¦¬ ì €ì¥
      saveChatToHistory(q, isError ? { error: data.error } : data, isError);

      // í›„ì† ì²˜ë¦¬
      if (data.status === "NEED_INFO" && data.next_question) {
        questionEl.placeholder = `[ì¶”ê°€ ìš”ì²­] ${data.next_question}`;
        questionEl.value = ""; // ë‚´ìš© ë¹„ìš°ê³  placeholderë¡œ ê°€ì´ë“œ
        questionEl.focus();
      } else {
        questionEl.placeholder = "ì¶”ê°€ ì§ˆë¬¸ì´ ìˆìœ¼ì‹ ê°€ìš”?";
        questionEl.value = ""; // ì™„ë£Œ ì‹œ ë¹„ì›€
      }

    } catch (e) {
      alert("ì„œë²„ ì˜¤ë¥˜: " + e.message);
    } finally {
      sendBtn.textContent = "ì§„ë‹¨ ìš”ì²­";
      sendBtn.disabled = false;
    }
  });
</script>
</body>
</html>